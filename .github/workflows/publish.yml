name: Publish Extension

on:
  push:
    tags:
      - '[0-9]+.[0-9]+.[0-9]+'  # åŒ¹é… x.y.z æ ¼å¼çš„æ­£å¼ç‰ˆæœ¬æ ‡ç­¾ï¼ˆä¸åŒ…å« .devï¼‰

permissions:
  contents: write

jobs:
  publish:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: latest

      - name: Get pnpm store directory
        shell: bash
        run: |
          echo "STORE_PATH=$(pnpm store path --silent)" >> $GITHUB_ENV

      - name: Setup pnpm cache
        uses: actions/cache@v4
        with:
          path: ${{ env.STORE_PATH }}
          key: ${{ runner.os }}-pnpm-store-${{ hashFiles('**/pnpm-lock.yaml') }}
          restore-keys: |
            ${{ runner.os }}-pnpm-store-

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Build extension
        run: pnpm run package

      - name: Install vsce
        run: pnpm add -g @vscode/vsce

      - name: Get tag version
        id: get_version
        run: |
          VERSION=${GITHUB_REF#refs/tags/}
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "Publishing version: $VERSION"

      - name: Verify package.json version matches tag
        run: |
          PACKAGE_VERSION=$(node -p "require('./package.json').version")
          TAG_VERSION="${{ steps.get_version.outputs.version }}"
          echo "Package.json version: $PACKAGE_VERSION"
          echo "Git tag version: $TAG_VERSION"
          if [ "$PACKAGE_VERSION" != "$TAG_VERSION" ]; then
            echo "Error: Package.json version ($PACKAGE_VERSION) does not match git tag ($TAG_VERSION)"
            exit 1
          fi

      - name: Package extension
        run: |
          # æ‰“åŒ…ç”Ÿæˆ .vsix æ–‡ä»¶
          pnpm vsce package --no-dependencies

      - name: Publish to VS Code Marketplace
        run: |
          # å‘å¸ƒåˆ°å¸‚åœº
          pnpm vsce publish --no-dependencies --pat ${{ secrets.VSCE_TOKEN }}
        env:
          VSCE_TOKEN: ${{ secrets.VSCE_TOKEN }}

      - name: Find previous version tag
        id: previous_tag
        run: |
          # è·å–å½“å‰æ ‡ç­¾
          CURRENT_TAG="${{ steps.get_version.outputs.version }}"
          
          # è·å–æ‰€æœ‰æ­£å¼ç‰ˆæœ¬æ ‡ç­¾ï¼ŒæŒ‰ç‰ˆæœ¬å·æ’åºï¼Œæ‰¾åˆ°å½“å‰æ ‡ç­¾ä¹‹å‰çš„æœ€æ–°æ ‡ç­¾
          PREVIOUS_TAG=$(git tag -l --sort=-version:refname | grep -E '^[0-9]+\.[0-9]+\.[0-9]+$' | grep -v "^$CURRENT_TAG$" | head -n1)
          
          if [ -n "$PREVIOUS_TAG" ]; then
            echo "Found previous tag: $PREVIOUS_TAG"
            echo "previous_tag=$PREVIOUS_TAG" >> $GITHUB_OUTPUT
          else
            echo "No previous tag found"
            echo "previous_tag=" >> $GITHUB_OUTPUT
          fi

      - name: Generate release notes
        id: release_notes
        run: |
          CURRENT_TAG="${{ steps.get_version.outputs.version }}"
          PREVIOUS_TAG="${{ steps.previous_tag.outputs.previous_tag }}"
          
          # åˆ›å»ºå‘å¸ƒè¯´æ˜æ–‡ä»¶
          echo "# VS Code Tree Enhancer v$CURRENT_TAG" > release_notes.md
          
          # æ£€æŸ¥æ˜¯å¦æœ‰ CHANGELOG.md æ–‡ä»¶å¹¶æå–ç›¸å…³ç‰ˆæœ¬ä¿¡æ¯
          if [ -f "CHANGELOG.md" ]; then
            echo "## æ›´æ–°å†…å®¹" >> release_notes.md
            
            # å°è¯•ä» CHANGELOG ä¸­æå–å½“å‰ç‰ˆæœ¬çš„æ›´æ–°å†…å®¹
            awk -v version="$CURRENT_TAG" '
              /^##/ { 
                if (found) exit
                if ($0 ~ version) found=1
                next
              }
              found && /^##/ { exit }
              found { print }
            ' CHANGELOG.md >> release_notes.md
          fi
          
          echo "" >> release_notes.md
          echo "## æäº¤è®°å½•" >> release_notes.md
          echo "" >> release_notes.md
          
          # ç”Ÿæˆæäº¤è®°å½•ï¼ˆæ’é™¤å¼€å‘ç‰ˆæœ¬ç›¸å…³çš„æäº¤ï¼‰
          if [ -z "$PREVIOUS_TAG" ]; then
            echo "ç”Ÿæˆä»åˆå§‹æäº¤åˆ° $CURRENT_TAG çš„æäº¤è®°å½•"
            git log --pretty=format:"- %s (%h)" --no-merges --grep="\.dev" --invert-grep >> release_notes.md
          else
            echo "ç”Ÿæˆä» $PREVIOUS_TAG åˆ° $CURRENT_TAG çš„æäº¤è®°å½•"
            git log "$PREVIOUS_TAG..$CURRENT_TAG" --pretty=format:"- %s (%h)" --no-merges --grep="\.dev" --invert-grep >> release_notes.md
          fi
          
          # å¦‚æœæ²¡æœ‰æäº¤è®°å½•ï¼Œæ·»åŠ é»˜è®¤ä¿¡æ¯
          if [ ! -s release_notes.md ] || [ $(wc -l < release_notes.md) -le 5 ]; then
            echo "- ç‰ˆæœ¬å‘å¸ƒ" >> release_notes.md
          fi
          
          echo "" >> release_notes.md
          echo "" >> release_notes.md
          echo "---" >> release_notes.md
          echo "" >> release_notes.md
          echo "ğŸ“¦ **å®‰è£…æ–¹å¼ï¼š**" >> release_notes.md
          echo "" >> release_notes.md
          echo "- é€šè¿‡ VS Code æ‰©å±•å¸‚åœºæœç´¢ \"Tree Enhancer\" å®‰è£…" >> release_notes.md
          echo "- æˆ–ä¸‹è½½ .vsix æ–‡ä»¶æ‰‹åŠ¨å®‰è£…" >> release_notes.md
          
          echo "ç”Ÿæˆçš„å‘å¸ƒè¯´æ˜:"
          cat release_notes.md

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ steps.get_version.outputs.version }}
          name: "Tree Enhancer v${{ steps.get_version.outputs.version }}"
          body_path: release_notes.md
          files: |
            *.vsix
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Upload VSIX artifact
        uses: actions/upload-artifact@v4
        with:
          name: vsix-package-${{ steps.get_version.outputs.version }}
          path: "*.vsix"
          retention-days: 90