name: Package Extension

on:
    push:
        tags:
            - "[0-9]+.[0-9]+.[0-9]+.dev.[0-9]+" # åŒ¹é… x.y.z.dev.n æ ¼å¼çš„å¼€å‘ç‰ˆæœ¬æ ‡ç­¾
    workflow_dispatch: # æ”¯æŒæ‰‹åŠ¨è¿è¡Œ

permissions:
    contents: write

jobs:
    package:
        runs-on: ubuntu-latest

        steps:
            - name: Checkout code
              uses: actions/checkout@v4
              with:
                  fetch-depth: 0

            - name: Setup Node.js
              uses: actions/setup-node@v4
              with:
                  node-version: "20"

            - name: Setup pnpm
              uses: pnpm/action-setup@v4
              with:
                  version: latest

            - name: Get pnpm store directory
              shell: bash
              run: |
                  echo "STORE_PATH=$(pnpm store path --silent)" >> $GITHUB_ENV

            - name: Setup pnpm cache
              uses: actions/cache@v4
              with:
                  path: ${{ env.STORE_PATH }}
                  key: ${{ runner.os }}-pnpm-store-${{ hashFiles('**/pnpm-lock.yaml') }}
                  restore-keys: |
                      ${{ runner.os }}-pnpm-store-

            - name: Install dependencies
              run: pnpm install --frozen-lockfile

            - name: Build extension
              run: pnpm run package

            - name: Install vsce
              run: pnpm add -g @vscode/vsce

            - name: Get version info
              id: get_version
              run: |
                  if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
                    # æ‰‹åŠ¨è¿è¡Œæ—¶ï¼Œä» package.json è·å–ç‰ˆæœ¬
                    VERSION=$(node -p "require('./package.json').version")
                    echo "Manual run - using package.json version: $VERSION"
                  else
                    # Tag è§¦å‘æ—¶ï¼Œä» tag è·å–ç‰ˆæœ¬
                    VERSION=${GITHUB_REF#refs/tags/}
                    echo "Tag triggered - using tag version: $VERSION"
                  fi
                  echo "version=$VERSION" >> $GITHUB_OUTPUT

            - name: Show version info
              run: |
                  PACKAGE_VERSION=$(node -p "require('./package.json').version")
                  TAG_VERSION="${{ steps.get_version.outputs.version }}"
                  echo "Package.json version: $PACKAGE_VERSION"
                  echo "Current version: $TAG_VERSION"
                  echo "â„¹ï¸ Development versions don't require exact version matching"

            - name: Package extension
              run: |
                  # æ‰“åŒ…ç”Ÿæˆ .vsix æ–‡ä»¶ï¼ˆä»…æ‰“åŒ…ï¼Œä¸å‘å¸ƒï¼‰
                  pnpm vsce package --no-dependencies

            - name: Create development release (for tag runs only)
              if: github.event_name != 'workflow_dispatch'
              uses: softprops/action-gh-release@v2
              with:
                  tag_name: ${{ steps.get_version.outputs.version }}
                  name: "Tree Enhancer v${{ steps.get_version.outputs.version }} (å¼€å‘ç‰ˆ)"
                  body: |
                      # ğŸš§ å¼€å‘ç‰ˆæœ¬ - ä»…ä¾›æµ‹è¯•

                      è¿™æ˜¯ä¸€ä¸ªå¼€å‘ç‰ˆæœ¬ï¼Œç”¨äºå†…éƒ¨æµ‹è¯•ã€‚è¯·ä¸è¦åœ¨ç”Ÿäº§ç¯å¢ƒä¸­ä½¿ç”¨ã€‚

                      ## ç‰ˆæœ¬ä¿¡æ¯
                      - ç‰ˆæœ¬å·: ${{ steps.get_version.outputs.version }}
                      - æ„å»ºæ—¶é—´: ${{ github.run_id }}
                      - æäº¤: ${{ github.sha }}

                      ## æ³¨æ„äº‹é¡¹
                      âš ï¸ æ­¤ç‰ˆæœ¬ä¸ä¼šå‘å¸ƒåˆ° VS Code å¸‚åœº
                      âš ï¸ ä»…é€šè¿‡ GitHub Release æä¾›ä¸‹è½½
                      âš ï¸ å¯èƒ½åŒ…å«æœªç»å……åˆ†æµ‹è¯•çš„åŠŸèƒ½

                      ---

                      ğŸ“¦ **å®‰è£…æ–¹å¼ï¼š** ä¸‹è½½ .vsix æ–‡ä»¶å¹¶åœ¨ VS Code ä¸­æ‰‹åŠ¨å®‰è£…
                  files: |
                      *.vsix
                  draft: false
                  prerelease: true
              env:
                  GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

            - name: Upload VSIX artifact
              uses: actions/upload-artifact@v4
              with:
                  name: vsix-package-${{ steps.get_version.outputs.version }}
                  path: "*.vsix"
                  retention-days: 30
